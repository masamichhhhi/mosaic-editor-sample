# モザイク付与動画エディタ 実装計画書

## 1. プロジェクト概要

動画の任意の位置に任意の秒数のモザイクを付与できるWebベースの動画エディタを実装する。
**※ブラウザ上での編集・プレビュー機能のみ（動画エクスポート機能はスコープ外）**

## 2. 技術スタック

### フロントエンド
- **React 18** + **TypeScript**: UIフレームワーク
- **Vite**: 高速ビルドツール
- **TailwindCSS**: スタイリング

### 動画処理・描画
- **HTML5 Video API**: 動画の再生・シーク制御
- **Canvas API**: モザイク処理とプレビュー表示
- **Fabric.js**: モザイク領域の描画・ドラッグ&リサイズ

### 状態管理
- **Zustand** または **React Context API**: アプリケーション状態管理

## 3. システムアーキテクチャ

```
┌─────────────────────────────────────────────┐
│         Video Mosaic Editor UI              │
├─────────────────────────────────────────────┤
│  ┌──────────────┐  ┌───────────────────┐   │
│  │ Video Upload │  │ Video Player      │   │
│  │ Component    │  │ (HTML5 Video)     │   │
│  └──────────────┘  └───────────────────┘   │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │ Canvas Overlay (Mosaic Drawing)      │  │
│  │ - Fabric.js for interactive rects    │  │
│  └──────────────────────────────────────┘  │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │ Seekbar & Controls                    │  │
│  └──────────────────────────────────────┘  │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │ Timeline (Mosaic Duration Display)    │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────┐
│    State Management (Zustand/Context)       │
│  - Uploaded video file                      │
│  - Current playback time                    │
│  - Mosaic regions list                      │
│    [{x, y, width, height, startTime, endTime}]│
└─────────────────────────────────────────────┘
```

## 4. 機能詳細設計

### 4.1 動画アップロード機能
- **実装方法**: `<input type="file" accept="video/*">`
- **処理フロー**:
  1. ファイル選択イベントで動画ファイルを取得
  2. `URL.createObjectURL()` でブラウザ内URLを生成
  3. Video要素にセット
  4. メタデータ読み込み完了後、動画の長さ・解像度を取得

### 4.2 動画再生・シーク機能
- **実装方法**: HTML5 Video APIの使用
- **主要機能**:
  - 再生/一時停止ボタン
  - シークバー（`<input type="range">`）
  - 現在時刻の表示
  - `video.currentTime` プロパティで時刻を制御

### 4.3 モザイク付与機能

#### 4.3.1 モザイク領域の描画
- **実装方法**: Fabric.jsを使用
- **処理フロー**:
  1. Canvas上にFabric.jsのRectオブジェクトを配置
  2. マウスドラッグで位置・サイズを調整可能
  3. 確定ボタンで現在時刻とモザイク領域情報を保存

#### 4.3.2 モザイク領域のデータ構造
```typescript
interface MosaicRegion {
  id: string;
  x: number;        // 動画内のX座標（px）
  y: number;        // 動画内のY座標（px）
  width: number;    // モザイク幅（px）
  height: number;   // モザイク高さ（px）
  startTime: number; // 開始秒数
  endTime: number;   // 終了秒数
}
```

#### 4.3.3 リアルタイムプレビュー
- 動画再生中、現在時刻に該当するモザイク領域をCanvas上に描画
- `requestAnimationFrame()` で毎フレーム更新
- Canvas APIの `ctx.filter = 'blur(10px)'` やピクセル加工でモザイク効果を実現

### 4.4 タイムライン機能
- **実装方法**: カスタムReactコンポーネント
- **表示内容**:
  - 動画全体の長さを横軸とする
  - 各モザイク領域を色付きバーで表示
  - 開始時刻〜終了時刻の範囲を視覚化
- **インタラクション**:
  - タイムラインのバーをクリックでそのモザイク領域の編集画面に遷移
  - 削除ボタンでモザイク領域を削除

## 5. ディレクトリ構成

```
mosaic-editor-sample/
├── src/
│   ├── components/
│   │   ├── VideoUploader.tsx      # 動画アップロード
│   │   ├── VideoPlayer.tsx         # 動画再生・シーク
│   │   ├── MosaicCanvas.tsx        # モザイク描画Canvas
│   │   └── Timeline.tsx            # タイムライン表示
│   ├── hooks/
│   │   ├── useVideoControl.ts      # 動画制御ロジック
│   │   └── useMosaicRegions.ts     # モザイク領域管理
│   ├── stores/
│   │   └── editorStore.ts          # Zustand状態管理
│   ├── utils/
│   │   └── mosaicRenderer.ts       # モザイク描画ロジック
│   ├── types/
│   │   └── index.ts                # 型定義
│   ├── App.tsx
│   └── main.tsx
├── public/
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

## 6. 実装ステップ

### Phase 1: プロジェクトセットアップ
1. Vite + React + TypeScript プロジェクト作成
2. 必要なライブラリのインストール
   - `fabric`, `zustand`
   - `tailwindcss`, `autoprefixer`, `postcss`
3. 基本的なディレクトリ構成の作成

### Phase 2: 動画アップロード・再生機能
1. `VideoUploader` コンポーネント実装
2. `VideoPlayer` コンポーネント実装
3. HTML5 Video APIでシーク・再生制御を実装
4. 状態管理の基盤構築（Zustand/Context）

### Phase 3: モザイク描画機能
1. `MosaicCanvas` コンポーネント実装
2. Fabric.jsでドラッグ&リサイズ可能な矩形を実装
3. モザイク領域の追加・編集・削除機能
4. Canvas上でのリアルタイムモザイクプレビュー実装

### Phase 4: タイムライン機能
1. `Timeline` コンポーネント実装
2. モザイク領域の時間範囲を視覚的に表示
3. タイムラインからのモザイク選択・削除機能

### Phase 5: UI/UX改善
1. レスポンシブデザイン対応
2. エラーハンドリングの実装
3. ローディング状態の表示
4. アクセシビリティ対応

## 7. 技術的課題と解決方法

### 7.1 大容量動画の処理
**課題**: 大きな動画ファイルのブラウザ処理は重い
**解決策**:
- 動画のプレビューは元ファイルを直接再生（変換不要）
- ファイルサイズの上限を設けてUXを維持

### 7.2 リアルタイムモザイクプレビュー
**課題**: 動画再生中のモザイク描画のパフォーマンス
**解決策**:
- Canvas描画の最適化（オフスクリーンCanvas使用）
- `requestAnimationFrame()` で効率的な再描画
- 必要な領域のみ再描画

### 7.3 複数モザイク領域の管理
**課題**: 重なり合うモザイク領域の処理
**解決策**:
- モザイク領域リストを時刻でソート
- 各フレームで該当する領域のみフィルタリング
- Z-indexによる優先順位管理

## 8. テスト計画

### 8.1 単体テスト
- ユーティリティ関数のテスト（Jest/Vitest）
- モザイク領域の計算ロジックテスト

### 8.2 統合テスト
- 動画アップロード〜再生フローのテスト
- モザイク追加〜プレビューフローのテスト

### 8.3 E2Eテスト
- Playwrightを使用したブラウザテスト
- 実際の動画ファイルを使った動作確認

## 9. 今後の拡張可能性

- **動画エクスポート機能**（FFmpeg.wasmを使用したモザイク適用済み動画の出力）
- モザイク領域の時間軸での移動・トラッキング機能
- 複数種類のエフェクト（ぼかし以外）
- 動画のトリミング・カット編集機能
- プロジェクトの保存・読み込み機能（JSON形式）
- 音声の編集機能
- 動画のプレビュー品質調整

## 10. UIデザイン方針

### カラースキーム
```css
:root {
  --bg-primary: #0f0f0f;      /* 深いダークグレー */
  --bg-secondary: #1a1a1a;    /* セカンダリ背景 */
  --accent: #6366f1;          /* インディゴアクセント */
  --accent-hover: #818cf8;    /* ホバー時 */
  --text-primary: #f5f5f5;    /* メインテキスト */
  --text-secondary: #a3a3a3;  /* サブテキスト */
  --mosaic-highlight: #22c55e; /* モザイク領域ハイライト */
  --timeline-bg: #262626;     /* タイムライン背景 */
}
```

### デザインコンセプト
- ダークモードベースの映像編集ソフト風UI
- ミニマルでプロフェッショナルな印象
- 直感的な操作性を重視

## 11. 技術的リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| 大容量動画でのパフォーマンス低下 | ユーザー体験の悪化 | 動画サイズ制限、Canvas最適化 |
| Canvas描画の遅延 | モザイクプレビューのカクつき | requestAnimationFrameの最適化、デバウンス処理 |
| ブラウザ互換性 | 特定ブラウザで動作しない | Can I Use確認、Polyfill導入 |
| メモリリーク | 長時間使用で重くなる | 適切なクリーンアップ処理 |

## 12. 成果物

1. **ソースコード**: React + TypeScript アプリケーション
2. **ドキュメント**: README.md（セットアップ手順、使用方法）
3. **デプロイ**: Vercel等へのデプロイ（オプション）

---

*作成日: 2026年1月12日*
